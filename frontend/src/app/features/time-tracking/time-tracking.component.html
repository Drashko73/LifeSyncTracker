<div class="p-4 md:p-6 bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors">
    <p-toast></p-toast>
    <p-confirmdialog></p-confirmdialog>

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
    <div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Time Tracking</h1>
        <p class="text-gray-500 dark:text-gray-400">Track your work sessions and manage time entries</p>
    </div>
    <div class="mt-4 md:mt-0">
        <p-button 
        label="Add Manual Entry" 
        icon="pi pi-plus" 
        (onClick)="showManualEntryDialog()"
        ></p-button>
    </div>
    </div>

    <!-- Timer Card -->
    <p-card class="mb-6" [class]="timeEntryService.isTimerRunning() ? 'ring-2 ring-blue-500' : ''">
    <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-4 md:mb-0">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2">Timer</h2>
        @if (timeEntryService.isTimerRunning()) {
            <p class="text-gray-500 dark:text-gray-400">
            Project: {{ timeEntryService.runningTimer()?.project?.name || 'No project selected' }}
            </p>
        }
        </div>
        
        <div class="flex items-center space-x-4">
        <span class="timer-display text-4xl font-mono dark:text-gray-100" [ngClass]="{'text-blue-600 dark:text-blue-400': timeEntryService.isTimerRunning()}">
            {{ timeEntryService.formatElapsedTime(timeEntryService.elapsedSeconds()) }}
        </span>
        
        @if (!timeEntryService.isTimerRunning()) {
            <p-button 
            label="Start" 
            icon="pi pi-play" 
            severity="success" 
            size="large"
            (onClick)="startTimer()"
            ></p-button>
        } @else {
            <p-button 
            label="Stop" 
            icon="pi pi-stop" 
            severity="danger" 
            size="large"
            (onClick)="showStopTimerDialog()"
            ></p-button>
        }
        </div>
    </div>
    </p-card>

    <!-- Filters -->
    <p-card class="mb-6">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Time Period</label>
        <p-select 
            [options]="userPreferencesService.getFilterPeriodOptions()" 
            [(ngModel)]="filterPeriod" 
            optionLabel="label" 
            optionValue="value"
            styleClass="w-full"
            (onChange)="onFilterPeriodChange()"
        ></p-select>
        </div>
        <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Project</label>
        <p-select 
            [options]="projects()" 
            [(ngModel)]="filterProjectId" 
            optionLabel="name" 
            optionValue="id"
            placeholder="All Projects"
            [showClear]="true"
            styleClass="w-full"
            (onChange)="loadTimeEntries()"
        ></p-select>
        </div>
        <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Date</label>
        <p-datepicker 
            [(ngModel)]="filterStartDate" 
            dateFormat="yy-mm-dd"
            [showIcon]="true"
            styleClass="w-full"
            (onSelect)="loadTimeEntries()"
        ></p-datepicker>
        </div>
        <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Date</label>
        <p-datepicker 
            [(ngModel)]="filterEndDate" 
            dateFormat="yy-mm-dd"
            [showIcon]="true"
            styleClass="w-full"
            (onSelect)="loadTimeEntries()"
        ></p-datepicker>
        </div>
        <div class="flex items-end">
        <p-button label="Clear Filters" icon="pi pi-times" severity="secondary" (onClick)="clearFilters()"></p-button>
        </div>
    </div>
    </p-card>

    <!-- Time Entries Table -->
    <p-card>
    <ng-template pTemplate="header">
        <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Time Entries</h2>
        <p-button
            label="PDF Report"
            icon="pi pi-file-pdf"
            severity="help"
            [outlined]="true"
            size="small"
            (onClick)="showPdfReportDialog()"
        ></p-button>
        </div>
    </ng-template>
    
    @if (isLoading()) {
        <div class="flex justify-center items-center h-32">
        <p-progressSpinner></p-progressSpinner>
        </div>
    } @else {
        <p-table 
        [value]="timeEntries()" 
        [paginator]="true" 
        [lazy]="true"
        [first]="first"
        (onLazyLoad)="pageChange($event)"
        [rows]="rows"
        [rowsPerPageOptions]="[10, 25, 50]"
        [showCurrentPageReport]="true"
        [totalRecords]="totalRecords"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        styleClass="p-datatable-sm"
        >
        <ng-template pTemplate="header">
            <tr>
            <th>Date</th>
            <th>Project</th>
            <th>Duration</th>
            <th>Description</th>
            <th>Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-entry>
            <tr>
            <td>{{ formatDateTime(entry.startTime) }}</td>
            <td>
                @if (entry.project) {
                <span 
                    class="px-2 py-1 rounded text-sm"
                    [style.backgroundColor]="entry.project.colorCode || '#e5e7eb'"
                    [style.color]="getContrastColor(entry.project.colorCode)"
                >
                    {{ entry.project.name }}
                </span>
                } @else {
                <span class="text-gray-400 dark:text-gray-500">No project</span>
                }
            </td>
            <td>{{ formatDuration(entry.durationMinutes) }}</td>
            <td class="max-w-xs truncate">{{ entry.description || '-' }}</td>
            <td>
                <div class="flex gap-2">
                <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" (onClick)="editTimeEntry(entry)"></p-button>
                <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="confirmDelete(entry)"></p-button>
                </div>
            </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
            <td colspan="5" class="text-center py-8 text-gray-500 dark:text-gray-400">
                No time entries found. Start tracking your time!
            </td>
            </tr>
        </ng-template>
        </p-table>
    }
    </p-card>

    <!-- Stop Timer Dialog -->
    <p-dialog 
    header="Stop Timer" 
    [(visible)]="showStopDialog" 
    [modal]="true" 
    [style]="{width: '500px'}"
    [closable]="true"
    [maximizable]="true"
    >
    <form [formGroup]="stopTimerForm">
        <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Project</label>
        <p-select 
            [options]="projects()" 
            formControlName="projectId" 
            optionLabel="name" 
            optionValue="id"
            placeholder="Select a project"
            [showClear]="true"
            styleClass="w-full"
        ></p-select>
        </div>
        <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">What have I done?</label>
        <textarea 
            pTextarea 
            formControlName="description" 
            rows="3" 
            class="w-full"
            placeholder="Describe what you worked on..."
        ></textarea>
        </div>
        <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">What should be done next?</label>
        <textarea 
            pTextarea 
            formControlName="nextSteps" 
            rows="3" 
            class="w-full"
            placeholder="Handover notes for next session..."
        ></textarea>
        </div>
        <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tags</label>
        <p-multiselect 
            [options]="tags()" 
            formControlName="tagIds" 
            optionLabel="name" 
            optionValue="id"
            placeholder="Select tags"
            styleClass="w-full"
        ></p-multiselect>
        </div>
    </form>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="showStopDialog = false"></p-button>
        <p-button label="Save & Stop" icon="pi pi-check" (onClick)="stopTimer()"></p-button>
    </ng-template>
    </p-dialog>

    <!-- Manual Entry Dialog -->
    <p-dialog 
    [header]="editingEntry ? 'Edit Time Entry' : 'Add Manual Entry'" 
    [(visible)]="showManualDialog" 
    [modal]="true" 
    [style]="{width: '500px'}"
    [closable]="true"
    [maximizable]="true"
    >
    <form [formGroup]="manualEntryForm">
        <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Time</label>
            <p-datepicker 
            formControlName="startTime" 
            [showTime]="true" 
            [showIcon]="true"
            dateFormat="yy-mm-dd"
            styleClass="w-full"
            ></p-datepicker>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Time</label>
            <p-datepicker 
            formControlName="endTime" 
            [showTime]="true" 
            [showIcon]="true"
            dateFormat="yy-mm-dd"
            styleClass="w-full"
            ></p-datepicker>
        </div>
        </div>
        <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Project</label>
        <p-select 
            [options]="projects()" 
            formControlName="projectId" 
            optionLabel="name" 
            optionValue="id"
            placeholder="Select a project"
            [showClear]="true"
            styleClass="w-full"
        ></p-select>
        </div>
        <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
        <textarea 
            pTextarea 
            formControlName="description" 
            rows="3" 
            class="w-full"
            placeholder="What did you work on?"
        ></textarea>
        </div>
        <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Next Steps</label>
        <textarea 
            pTextarea 
            formControlName="nextSteps" 
            rows="3" 
            class="w-full"
            placeholder="Handover notes..."
        ></textarea>
        </div>
        <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tags</label>
        <p-multiselect 
            [options]="tags()" 
            formControlName="tagIds" 
            optionLabel="name" 
            optionValue="id"
            placeholder="Select tags"
            styleClass="w-full"
        ></p-multiselect>
        </div>
    </form>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="showManualDialog = false"></p-button>
        <p-button [label]="editingEntry ? 'Update' : 'Save'" icon="pi pi-check" (onClick)="saveManualEntry()"></p-button>
    </ng-template>
    </p-dialog>

    <!-- PDF Report Dialog -->
    <p-dialog
    header="Generate PDF Report"
    [(visible)]="showPdfDialog"
    [modal]="true"
    [style]="{width: '400px', height: 'auto'}"
    [closable]="true"
    [maximizable]="true"
    >
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Project</label>
        <p-select
        [options]="projects()"
        [(ngModel)]="pdfProjectId"
        optionLabel="name"
        optionValue="id"
        placeholder="Select a project"
        appendTo="body"
        styleClass="w-full"
        ></p-select>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Year</label>
        <p-select
            [options]="pdfYearOptions"
            [(ngModel)]="pdfYear"
            optionLabel="label"
            optionValue="value"
            appendTo="body"
            styleClass="w-full"
        ></p-select>
        </div>
        <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Month</label>
        <p-select
            [options]="pdfMonthOptions"
            [(ngModel)]="pdfMonth"
            optionLabel="label"
            optionValue="value"
            appendTo="body"
            styleClass="w-full"
        ></p-select>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="showPdfDialog = false"></p-button>
        <p-button
        label="Download"
        icon="pi pi-download"
        (onClick)="downloadPdfReport()"
        [disabled]="!pdfProjectId"
        [loading]="isDownloadingPdf"
        ></p-button>
    </ng-template>
    </p-dialog>
</div>